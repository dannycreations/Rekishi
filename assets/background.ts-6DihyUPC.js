import{B as l,p as f,S as m,a as g,C as u,c as C,m as U,b as i,R as c,d as _,e as h,i as A}from"./constants-wkB9i8m8.js";let y={plain:new Set,domainRegex:null,urlRegex:null},p=[],E={..._};const w=e=>{p=e,y=C(e)},S=e=>{E=e},L=async()=>{const e=await h.getItem(l);w(f(e));const t=await h.getItem(m);S(g(t))},T=e=>A(e,y),b=async()=>{if(!(typeof chrome>"u"||!chrome.history?.search||!chrome.history?.deleteUrl||p.length===0))try{const t=(await chrome.storage.local.get(i))[i]||0,s=Date.now(),o=await chrome.history.search({text:"",maxResults:0,startTime:t}),n=new Set(o.filter(r=>r.url&&T(r.url)).map(r=>r.url));if(n.size>0){const r=Array.from(n).map(d=>chrome.history.deleteUrl({url:d}).catch(a=>{const k=a instanceof Error?a.message:String(a);console.error(`Error deleting blacklisted URL during cleanup (${d}):`,k)}));await Promise.all(r)}await chrome.storage.local.set({[i]:s})}catch(e){const t=e instanceof Error?e.message:"Unknown error";console.error("Error in blacklist cleanup:",t)}},R=async()=>{if(!(typeof chrome>"u"||!chrome.history?.deleteRange))try{const t=(await chrome.storage.local.get(c))[c]||0,s=Date.now();if(s-t<1440*60*1e3)return;const{dataRetention:o}=E;if(o==="disabled")return;const n=parseInt(o,10);if(isNaN(n)||n<=0)return;const r=new Date;r.setDate(r.getDate()-n),r.setHours(0,0,0,0),await chrome.history.deleteRange({startTime:0,endTime:r.getTime()}),await chrome.storage.local.set({[c]:s})}catch(e){const t=e instanceof Error?e.message:"Unknown error";console.error("Error cleaning up old history:",t)}},I=async e=>{if(e.url)if(T(e.url)){if(typeof chrome<"u"&&chrome.history?.deleteUrl)try{await chrome.history.deleteUrl({url:e.url})}catch(t){const s=t instanceof Error?t.message:"Unknown error";console.error(`Error deleting blacklisted URL (${e.url}):`,s)}}else typeof chrome<"u"&&chrome.runtime?.sendMessage&&chrome.runtime.sendMessage({payload:U(e),type:"NEW_HISTORY_ITEM"})};typeof chrome<"u"&&chrome.storage?.onChanged&&chrome.storage.onChanged.addListener((e,t)=>{if(t==="sync"&&e[l]){const s=e[l].newValue??null;w(f(s))}if(t==="sync"&&e[m]){const s=e[m].newValue??null;S(g(s))}});typeof chrome<"u"&&chrome.history?.onVisited&&chrome.history.onVisited.addListener(I);typeof chrome<"u"&&chrome.alarms&&(chrome.alarms.create(u,{delayInMinutes:1,periodInMinutes:15}),chrome.alarms.onAlarm.addListener(async e=>{e.name===u&&(await b(),await R())}));L();R();
